name: build and tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build the Docker image
      working-directory: chacra_image
      run: docker build -t chacra .
    
    - name: Set up Docker Compose
      uses: docker/setup-compose-action@v1

    - name: docker compose up -d
      run: |
        docker compose up -d
        sleep 30
    
    - name: setup chacractl
      run: |
        pip install chacractl
        cat > ~/.chacractl << 'EOF'
        # This file was automatically generated by the chacractl CLI
        # make sure to update it with the correct user and key to talk to the API
        url = "http://127.0.0.1/"
        user = "admin"
        key = "secret"
        ssl_verify = False
        EOF

    - name: test
      run: |
        wget https://chacra.ceph.com/r/libboost/master/9ea1fb8bdad548a88004db87761f173aa50dcc85/ubuntu/jammy/flavors/default/pool/main/b/boost1.87/ceph-libboost-atomic1.87-dev_1.87.0-1.1_amd64.deb

        ls *.deb | chacractl binary create libboost/master/9ea1fb8bdad548a88004db87761f173aa50dcc85/ubuntu/jammy/amd64/flavors/default

        rm -f ./ceph-libboost-atomic1.87-dev_1.87.0-1.1_amd64.deb

        ls -l

        wget  http://127.0.0.1/binaries/libboost/master/9ea1fb8bdad548a88004db87761f173aa50dcc85/ubuntu/jammy/amd64/flavors/default/ceph-libboost-atomic1.87-dev_1.87.0-1.1_amd64.deb

        ls -l

    - name: clean
      run: |
        rm -f ./ceph-libboost-atomic1.87-dev_1.87.0-1.1_amd64.deb
        sudo docker compose down